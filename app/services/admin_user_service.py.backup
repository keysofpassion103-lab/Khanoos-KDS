from typing import Dict
from fastapi import HTTPException, status
from datetime import timedelta
from app.database import supabase
from app.auth.utils import get_password_hash, verify_password, create_access_token
from app.config import settings
from app.schemas.admin_user import AdminUserCreate, AdminUserLogin, AdminUserUpdate


class AdminUserService:

    @staticmethod
    async def register(data: AdminUserCreate) -> Dict:
        """Register a new admin user"""

        # Check if email already exists
        existing = supabase.table("admin_users").select("id").eq(
            "email", data.email
        ).execute()

        if existing.data:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="Email already registered"
            )

        try:
            hashed_password = get_password_hash(data.password)

            insert_data = {
                "email": data.email,
                "password_hash": hashed_password,
                "full_name": data.full_name,
                "phone": data.phone
            }

            response = supabase.table("admin_users").insert(insert_data).execute()

            if not response.data:
                raise HTTPException(
                    status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
                    detail="Failed to create admin user"
                )

            admin = response.data[0]
            return {
                "id": admin["id"],
                "email": admin["email"],
                "full_name": admin["full_name"],
                "phone": admin.get("phone"),
                "created_at": admin["created_at"]
            }

        except HTTPException:
            raise
        except Exception as e:
            raise HTTPException(
                status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
                detail=f"Registration failed: {str(e)}"
            )

    @staticmethod
    async def login(data: AdminUserLogin) -> Dict:
        """Login admin user and return JWT token"""

        # Fetch admin by email
        response = supabase.table("admin_users").select("*").eq(
            "email", data.email
        ).execute()

        if not response.data:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="Invalid email or password"
            )

        admin = response.data[0]

        # Verify password
        if not verify_password(data.password, admin["password_hash"]):
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="Invalid email or password"
            )

        # Create JWT with user_type: admin_user
        access_token_expires = timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)
        access_token = create_access_token(
            data={
                "sub": admin["id"],
                "email": admin["email"],
                "user_type": "admin_user"
            },
            expires_delta=access_token_expires
        )

        return {
            "admin": {
                "id": admin["id"],
                "email": admin["email"],
                "full_name": admin["full_name"],
                "phone": admin.get("phone"),
                "created_at": admin["created_at"]
            },
            "access_token": access_token,
            "token_type": "bearer"
        }

    @staticmethod
    async def get_profile(admin_id: str) -> Dict:
        """Get admin user profile"""

        response = supabase.table("admin_users").select(
            "id, email, full_name, phone, created_at"
        ).eq("id", admin_id).execute()

        if not response.data:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="Admin user not found"
            )

        return response.data[0]

    @staticmethod
    async def update(admin_id: str, data: AdminUserUpdate) -> Dict:
        """Update admin user profile"""

        update_data = data.dict(exclude_unset=True)

        if not update_data:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="No data provided for update"
            )

        response = supabase.table("admin_users").update(
            update_data
        ).eq("id", admin_id).execute()

        if not response.data:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="Admin user not found"
            )

        admin = response.data[0]
        return {
            "id": admin["id"],
            "email": admin["email"],
            "full_name": admin["full_name"],
            "phone": admin.get("phone"),
            "created_at": admin["created_at"]
        }

    @staticmethod
    async def change_password(admin_id: str, old_password: str, new_password: str) -> Dict:
        """Change admin user password"""

        # Fetch admin with password hash
        response = supabase.table("admin_users").select("*").eq(
            "id", admin_id
        ).execute()

        if not response.data:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="Admin user not found"
            )

        admin = response.data[0]

        # Verify old password
        if not verify_password(old_password, admin["password_hash"]):
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="Current password is incorrect"
            )

        # Update password
        new_hash = get_password_hash(new_password)
        supabase.table("admin_users").update(
            {"password_hash": new_hash}
        ).eq("id", admin_id).execute()

        return {"message": "Password changed successfully"}
